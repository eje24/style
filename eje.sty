\ProvidesPackage{eje}
\RequirePackage{ejemath} %math related macros
\RequirePackage{kvoptions}
%Many thanks to Jason Chen, from whose style file this one drew significant inspiration (structurally and otherwise)
%Improvements include:

\newif\ifeje@date        \eje@datetrue
\newif\ifeje@sf          \eje@sftrue
\newif\ifeje@header      \eje@headerfalse
\newif\ifeje@box         \eje@boxtrue
\newif\ifeje@code        \eje@codefalse
\newif\ifeje@marginnum   \eje@marginnumtrue
\newif\ifeje@monochrome  \eje@monochromefalse
\newif\ifeje@newpage    \eje@newpagefalse
\newif\ifeje@homework   \eje@homeworkfalse



\DeclareVoidOption{nodate}{\eje@datefalse}
\DeclareVoidOption{serifs}{\eje@sftrue}
\DeclareVoidOption{header}{\eje@headertrue}
\DeclareVoidOption{nobox}{\eje@boxfalse}
\DeclareVoidOption{nomarginnum}{\eje@marginnumfalse}
\DeclareVoidOption{homework}{\eje@homeworktrue \eje@monochrometrue}
\DeclareVoidOption{monochrome}{\eje@monochrometrue}
\DeclareVoidOption{newpage}{\eje@newpagetrue}
\DeclareStringOption[Fuchsia]{monocolor}
\DeclareStringOption[Orange]{claimcolor}
\DeclareStringOption[Ezra Erives]{name}
\DeclareStringOption[OrangeRed]{hlcolor}

\ProcessKeyvalOptions*

% \newcommand{\mcolor}{\eje@monocolor}

\KOMAoptions{
	paper=letter,
	fontsize=10pt,
	usegeometry,
	numbers=noendperiod,
}


% FROM chezbase
\RequirePackage{xparse}
\RequirePackage{etoolbox}

\RequirePackage[T1]{fontenc}


\RequirePackage[dvipsnames]{xcolor}
\RequirePackage{graphicx} %graphics stuff

%For homework organization
\ifeje@homework \RequirePackage{subfiles} \fi

%pset stuff - additional \psetclasse's are overridden by the initial one
\newcommand{\classname}{18.701}
\newcommand{\setpsetclass}[1]{
    \renewcommand{\classname}{#1}
}


% Make \bfseries include \boldmath
\g@addto@macro\bfseries{\boldmath}

%% Make cases environment use \lbrack instead of \lbrace
%\patchcmd{\env@cases}{\lbrace}{\lbrack}{}{}

% I use this enough to need this
\definecolor{todocolor}{rgb}{0.8, 0.1, 0.1}
\NewDocumentCommand{\TODO}{o}{\textcolor{todocolor}{TODO\IfNoValueF{#1}{: #1}}}

\DeclarePairedDelimiterX{\set}[1]{\lbrace}{\rbrace}{
	\RenewDocumentCommand{\mid}{}{\;\delimsize\vert\;}%
	#1
}



\RequirePackage{algpseudocode}
\newenvironment{alg}{\begin{algorithm}\begin{algorithmic}}{\end{algorithmic}\end{algorithm}}
%END chezBASE

%Typography
\RequirePackage{lmodern}
\usepackage{cmbright}
\usefont{T1}{cmtl}{m}{n}
\ifeje@sf
	\RequirePackage[defaultsans, scale=0.95]{lato}
	\SetMathAlphabet\mathsf{normal}{OT1}{\sfdefault}{m}{n}
	\SetMathAlphabet\mathsf{bold}{OT1}{\sfdefault}{b}{n}
\fi
\RequirePackage{microtype}
\RequirePackage[nodisplayskipstretch, onehalfspacing]{setspace}

% Page Margins
\RequirePackage{geometry}
\geometry{margin=2.0cm, includefoot}
\ifeje@header\geometry{includehead}\fi

% Headers
\ifeje@header\RequirePackage{scrlayer-scrpage}\fi

% Diagrams
\RequirePackage{tikz}
\usetikzlibrary{calc, cd, math, positioning}

% Macros
\RequirePackage[shortlabels, inline]{enumitem}

% Theorem Boxes
\ifeje@box\RequirePackage{tcolorbox}\fi

% References
\PassOptionsToPackage{pdftex, pdfcreator={LaTeX with eje.sty by Ezra Erives}}{hyperref}
\RequirePackage[colorlinks]{hyperref} % load this last generally
\definecolor{urlcolor}{rgb}{0.9, 0, 0.5}
\definecolor{linkcolor}{rgb}{0, 0.2, 0.8}
\definecolor{citecolor}{rgb}{0, 0.6, 0.3}
\hypersetup{urlcolor=urlcolor, linkcolor=linkcolor, citecolor=citecolor}

% cleveref must be loaded after hyperref
% also is really picky and wants to be loaded after everything
\RequirePackage[nameinlink]{cleveref}

% SETUP
\author{\eje@name}

\ifeje@date\else\date{~\vspace{-3em}}\fi

% Stylize things
% \patchcmd{\@maketitle}{\huge}{\large}{}{}
\setkomafont{author}{\normalsize\scshape}
\setkomafont{date}{\normalsize}
\ifeje@sf\else\setkomafont{disposition}{\normalcolor\bfseries}\fi
\ifeje@header\setkomafont{pageheadfoot}{\normalcolor}\fi
\RedeclareSectionCommand[beforeskip=0.4\baselineskip]{paragraph}

% Section numbers in the margin
\ifeje@marginnum
	\RenewDocumentCommand{\sectionlinesformat}{m m m m}{\makebox[0pt][r]{#3}#4}
\fi

\allowdisplaybreaks
\AtBeginDocument{
	\setlength{\belowdisplayskip}{0.5em}
	\setlength{\belowdisplayshortskip}{0.2em}
	\setlength{\abovedisplayskip}{0.5em}
	\setlength{\abovedisplayshortskip}{0.2em}
}

\RenewDocumentCommand{\arraystretch}{}{0.8}
\setlist{noitemsep, topsep=0.4em, listparindent=\parindent}

% Make itemize bullets smaller
\RenewDocumentCommand{\labelitemi}{}{$\vcenter{\hbox{\tiny\textbullet}}$}

%Make enumerate use lowercase letters
\renewcommand{\labelenumi}{\textbf{(\alph{enumi})}}

% Solution environment
\newenvironment{testenv}{\noindent \textbf{BLAH}}{\hfill \ensuremath{\square}}
\newenvironment{solution}{\noindent \textbf{Solution: }}{\hfill\ensuremath{\square}\ifeje@newpage\newpage\else\newline\fi}
\newenvironment{tproof}{\noindent \textbf{Proof: }}{\hfill \ensuremath{\blacksquare} \vspace{2mm}}
% \newenvironment{tdef}{\newline\noindent \textbf{Definition: }}{\hfill\newline} ----- deprecated
% \newenvironment{tlemma}{\newline\noindent \textbf{Lemma: }}{\hfill\newline} ------ deprecated



% Better default bracket width/height
\let\oldunderbracket\underbracket
\RenewDocumentCommand{\underbracket}{O{0.12ex} O{0.6ex} m}{\oldunderbracket[#1][#2]{#3}}


\newcommand{\obold}[1]{{\bfseries\color{\eje@claimcolor}#1}}

%Claimbox - not numbered environment
\newenvironment{claimbox}{\begin{tcolorbox}[
    enhanced jigsaw,breakable,
    fonttitle=\ifeje@sf\sffamily\fi\bfseries,
    colback=\eje@claimcolor!5!white,
    colframe=\eje@claimcolor,
    sharp corners,
    boxrule=0mm,
    left=0.5mm,
    top=0.8mm,
    bottom=0.8mm,
    before skip=8pt plus 2pt,
    after skip=8pt plus 2pt
    ] \obold{Claim:}
}{\end{tcolorbox}}

\newenvironment{notebox}{\begin{tcolorbox}[
    enhanced jigsaw,breakable,
    fonttitle=\ifeje@sf\sffamily\fi\bfseries,
    colback=Violet!5!white,
    colframe=Violet,
    sharp corners,
    boxrule=0mm,
    left=0.5mm,
    top=0.8mm,
    bottom=0.8mm,
    before skip=8pt plus 2pt,
    after skip=8pt plus 2pt
    ] \obold{Note:}
}{\end{tcolorbox}}

\newenvironment{cbox}[2]{
\begin{tcolorbox}[
    enhanced jigsaw,breakable,
    fonttitle=\ifeje@sf\sffamily\fi\bfseries,
    colback=Violet!5!white,
    colframe=Violet,
    sharp corners,
    boxrule=0mm,
    left=0.5mm,
    top=0.8mm,
    bottom=0.8mm,
    before skip=8pt plus 2pt,
    after skip=8pt plus 2pt
    ] \obold{#1:}
}{\end{tcolorbox}}

\newenvironment{factbox}{\begin{tcolorbox}[
    enhanced jigsaw,breakable,
    fonttitle=\ifeje@sf\sffamily\fi\bfseries,
    colback=Violet!5!white,
    colframe=Violet,
    sharp corners,
    boxrule=0mm,
    left=0.5mm,
    top=0.8mm,
    bottom=0.8mm,
    before skip=8pt plus 2pt,
    after skip=8pt plus 2pt
    ] \obold{Fact:}
}{\end{tcolorbox}}


\newenvironment{problembox}[1]{\begin{tcolorbox}[
    enhanced jigsaw,breakable,
    fonttitle=\ifeje@sf\sffamily\fi\bfseries,
    colback=CadetBlue!15!white,
    colframe=CadetBlue,
    sharp corners,
    boxrule=0mm,
    leftrule=2pt,
    left=0.8mm,
    top=1.0mm,
    bottom=1.0mm,
    before skip=8pt plus 2pt,
    after skip=8pt plus 2pt
    ] \textcolor{CadetBlue}{\textbf{Problem\ #1:}}
}{\end{tcolorbox}}


% Theorem boxes (Heavily copied from Daniel Zhu)
\ifeje@box
	\tcbuselibrary{skins, theorems, xparse, breakable}
	\ifeje@monochrome
       	\tcbset{
    		ejebox/.style={
    			enhanced jigsaw,
    			breakable,
    			fonttitle=\ifeje@sf\sffamily\fi\bfseries,
    			sharp corners,
    			boxrule=1pt,
    			leftrule=1pt,
    			left=5pt,
    			coltitle=black,
                detach title,
    		},
    		ejemonobox/.style={
    			ejebox,
    			coltitle=\eje@monocolor!80!black,
    			colframe=\eje@monocolor!80,
                colback=\eje@monocolor!7,
                detach title,
    		},
            ejebluethm/.style={ejemonobox, ejethm},
    		ejegreenthm/.style={ejemonobox, ejethm},
    	    ejeorangethm/.style={ejemonobox, ejethm},
    	    ejeredthm/.style={ejemonobox, ejethm},
    		ejethm/.style={
    			theorem style=break,
    			separator sign none,
    			description delimiters parenthesis,
    			description font=\normalfont\ifeje@sf\sffamily\fi\small,
                terminator sign none,
                detach title,
    		},
    	}
	\else 
    	\tcbset{
    		ejebox/.style={
    			enhanced jigsaw,
    			breakable,
    			fonttitle=\ifeje@sf\sffamily\fi\bfseries,
    			sharp corners,
    			boxrule=1pt,
    			leftrule=1pt,
    			left=5pt,
    			coltitle=black,
    			detach title,
    		},
    		ejebluebox/.style={
    			ejebox,
    			coltitle=blue!80!black,
    			colframe=blue!80,
                colback=blue!7,
                detach title,
    		},
    		ejegreenbox/.style={
    			ejebox,
    			coltitle=green!40!black,
    			colframe=green!70!black,
                colback=green!7,
                detach title,
    		},
    		ejeorangebox/.style={
    			ejebox,
    			coltitle=orange!80!black,
    			colframe=orange!98!black,
                colback=orange!8,
                detach title,
    		},
    		ejeredbox/.style={
    			ejebox,
    			coltitle=red!60!black,
    			colframe=red!80!black,
                colback=red!7,
                detach title,
    		},
            ejebluethm/.style={ejebluebox, ejethm},
    		ejegreenthm/.style={ejegreenbox, ejethm},
    	    ejeorangethm/.style={ejeorangebox, ejethm},
    	    ejeredthm/.style={ejeredbox, ejethm},
    		ejethm/.style={
    			theorem style=break,
    			separator sign none,
    			description delimiters parenthesis,
    			description font=\normalfont\ifeje@sf\sffamily\fi\small,
    			terminator sign none,
    		},
    	}
    \fi

	\ifeje@marginnum
		\newcommand*{\eje@drawmarginnumber}[1]{
			\node[anchor=north east,
				inner sep=0pt,
				xshift=-0.8em,
				yshift=-1.865ex,
				font=\ifeje@sf\sffamily\fi\bfseries\color{tcbcoltitle}\mathstrut\small]
				at (frame.north west) {#1};
		}
		\tcbset{
			ejethmmargin/.style={
				enhanced jigsaw,
				theorem name,
				extras unbroken and first={
					overlay={
						\ifdef{\thetcbthmcounter}{
							\eje@drawmarginnumber{\thetcbthmcounter}
						}{
							\ifdef{\thetcbcounter}{\eje@drawmarginnumber{\thetcbcounter}}
						}
					},
				},
			},
			ejethm/.append style=ejethmmargin,
		}
	\fi
	% TODO: footnotes
	% TODO: custom package options so that environment colors can be chosen at start for example [definition=Cerulean, problem=Fuchsia...]
\fi

% Redefine to reduce surrounding spacing
\RenewDocumentEnvironment{proof}{o}{\pushQED{\qed}\par\noindent\textit{Proof\IfNoValueF{#1}{ (#1)}}.}{\popQED\par\medskip}
\NewDocumentEnvironment{proof*}{m}{\pushQED{\qed}\par\noindent\textit{#1}.}{\popQED\par\medskip}


% TODO stuff
% regular environments + colored environments
% 
%
%
%